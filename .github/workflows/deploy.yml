name: Deploy to VPS with Disk Management

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

    - name: Add VPS to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: Copy files to VPS
      run: |
        rsync -avz --exclude '.git' --exclude '__pycache__' --exclude '.github' --exclude 'staticfiles' --exclude 'venv' --exclude '*.pyc' --exclude '.env' ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/root/pilito

    - name: SSH and deploy on VPS
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /root/pilito
          
          echo "ðŸš€ Starting automated deployment with disk management..."
          
          # Enhanced disk management and cleanup
          echo "ðŸ’¾ Performing comprehensive disk cleanup before deployment..."
          
          # Always perform aggressive cleanup before deployment
          echo "ðŸ§¹ Performing aggressive Docker cleanup..."
          
          # Stop all containers first to free up running container space
          docker stop $(docker ps -aq) 2>/dev/null || true
          
          # Remove all stopped containers
          docker container prune -f || true
          
          # Remove all unused images (not just dangling ones)
          docker image prune -af || true
          
          # Remove all unused volumes
          docker volume prune -f || true
          
          # Remove all unused networks
          docker network prune -f || true
          
          # Remove all build cache
          docker builder prune -af || true
          
          # Complete system cleanup - remove everything not currently in use
          docker system prune -af --volumes || true
          
          # Clean up Docker log files that can grow very large
          echo "ðŸ“ Cleaning up Docker logs..."
          find /var/lib/docker/containers/ -name "*-json.log" -exec truncate -s 0 {} \; 2>/dev/null || true
          
          # Clean up system logs more aggressively
          echo "ðŸ“ Cleaning up system logs..."
          journalctl --vacuum-time=1d || true
          journalctl --vacuum-size=100M || true
          find /var/log -name "*.log" -type f -mtime +1 -delete || true
          find /var/log -name "*.log.*" -type f -delete || true
          
          # Clean up temporary files and caches
          echo "ðŸ—‘ï¸ Cleaning up temporary files and caches..."
          rm -rf /tmp/* || true
          rm -rf /var/tmp/* || true
          rm -rf /var/cache/apt/archives/* || true
          
          # Clean up APT cache and packages
          echo "ðŸ“¦ Cleaning up APT cache..."
          apt-get clean || true
          apt-get autoremove -y --purge || true
          apt-get autoclean || true
          
          # Clean up old application files and backups
          echo "ðŸ—‚ï¸ Cleaning up old application files..."
          find /root/pilito -name "*.pyc" -delete 2>/dev/null || true
          find /root/pilito -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find /root/pilito -name "*.log" -mtime +1 -delete 2>/dev/null || true
          
          echo "ðŸ’¾ Disk space after cleanup:"
          df -h
          
          # Check available space and warn if still low
          AVAILABLE_SPACE=$(df / | awk 'NR==2 {print $4}')
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "Available space: ${AVAILABLE_GB}GB"
          
          if [ "$AVAILABLE_GB" -lt 2 ]; then
            echo "âš ï¸ WARNING: Still low on disk space (${AVAILABLE_GB}GB available)"
            echo "ðŸ” Top 10 largest directories:"
            du -h / 2>/dev/null | sort -hr | head -10 || true
          else
            echo "âœ… Sufficient disk space available (${AVAILABLE_GB}GB)"
          fi
          
          # Stop existing containers
          echo "ðŸ›‘ Stopping containers..."
          docker-compose down || true
          
          # Build with optimized settings for reliable deployment
          echo "ðŸ”¨ Building containers with optimized settings..."
          
          # Use Docker BuildKit for better caching and smaller images
          export DOCKER_BUILDKIT=1
          export COMPOSE_DOCKER_CLI_BUILD=1
          
          # Build with parallel processing for faster builds
          docker-compose build --pull --parallel
          
          # Clean up any temporary build artifacts immediately
          docker builder prune --filter "until=1h" -f || true
          
          # Start all services (including Celery and monitoring)
          echo "âš¡ Starting all services..."
          docker-compose up -d --remove-orphans
          
          # Wait for services to initialize
          echo "â³ Waiting for services to start..."
          sleep 20
          
          # Health check
          echo "ðŸ” Performing health checks..."
          
          # Check if all containers are running
          if ! docker-compose ps | grep -q "Up"; then
            echo "âŒ Some containers failed to start!"
            docker-compose logs --tail=20
            exit 1
          fi
          
          # Check Django app health with better error reporting
          echo "ðŸ”§ Checking Django application..."
          if ! docker exec django_app python manage.py check; then
            echo "âŒ Django health check failed!"
            echo "ðŸ“‹ Container logs:"
            docker logs django_app --tail 50
            echo "ðŸ“‹ Container environment:"
            docker exec django_app env | grep -E "(DJANGO|PYTHON)" || true
            exit 1
          fi
          
          # Run migrations
          echo "ðŸ“Š Running database migrations..."
          docker exec django_app python manage.py migrate --noinput
          
          # Collect static files
          echo "ðŸ“¦ Collecting static files..."
          docker exec django_app python manage.py collectstatic --noinput || true
          
          # Check Celery worker
          echo "âš™ï¸ Checking Celery worker..."
          sleep 5
          if ! docker exec celery_worker celery -A core inspect ping > /dev/null 2>&1; then
            echo "âš ï¸ Celery worker starting up..."
          else
            echo "âœ… Celery worker is running"
          fi
          
          # Check Celery beat
          echo "ðŸ“… Checking Celery beat..."
          if docker ps | grep -q celery_beat; then
            echo "âœ… Celery beat is running"
          else
            echo "âš ï¸ Celery beat may need attention"
          fi
          
          # Post-deployment cleanup
          echo "ðŸ§¹ Post-deployment cleanup..."
          
          # Remove any build artifacts older than 2 hours
          docker builder prune --filter "until=2h" -f || true
          
          # Remove any dangling images created during build
          docker image prune -f || true
          
          # Remove any temporary containers
          docker container prune -f || true
          
          # Final disk space check
          echo ""
          echo "ðŸ’¾ Final disk space after deployment:"
          df -h
          
          FINAL_AVAILABLE_GB=$(df / | awk 'NR==2 {print int($4/1024/1024)}')
          echo "Final available space: ${FINAL_AVAILABLE_GB}GB"
          
          # Set up automated cleanup if not already configured
          if [ ! -f "/etc/cron.d/pilito-cleanup" ]; then
            echo "âš™ï¸ Setting up automated cleanup tasks..."
            
            # Create cleanup cron job using echo
            echo "# Pilito Backend Automated Cleanup" > /tmp/pilito-cleanup
            echo "SHELL=/bin/bash" >> /tmp/pilito-cleanup
            echo "PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin" >> /tmp/pilito-cleanup
            echo "" >> /tmp/pilito-cleanup
            echo "# Run full cleanup every Sunday at 2 AM" >> /tmp/pilito-cleanup
            echo "0 2 * * 0 root docker system prune -af --volumes >/tmp/weekly-cleanup.log 2>&1" >> /tmp/pilito-cleanup
            echo "" >> /tmp/pilito-cleanup
            echo "# Clean Docker logs every day at 3 AM" >> /tmp/pilito-cleanup
            echo "0 3 * * * root find /var/lib/docker/containers/ -name \"*-json.log\" -exec truncate -s 10M {} \\; 2>/dev/null || true" >> /tmp/pilito-cleanup
            echo "" >> /tmp/pilito-cleanup
            echo "# Clean system logs daily at 4 AM" >> /tmp/pilito-cleanup
            echo "0 4 * * * root journalctl --vacuum-time=7d >/dev/null 2>&1" >> /tmp/pilito-cleanup
            
            mv /tmp/pilito-cleanup /etc/cron.d/pilito-cleanup
            chmod 644 /etc/cron.d/pilito-cleanup
            systemctl reload cron || service cron reload
            echo "âœ… Automated cleanup configured"
          else
            echo "âœ… Automated cleanup already configured"
          fi
          
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸ“Š Container status:"
          docker-compose ps
          
          echo ""
          echo "System Health Summary"
          echo "======================"
          echo "Available Space - ${FINAL_AVAILABLE_GB}GB"
          RUNNING=$(docker ps | grep -c Up || echo 0)
          echo "Docker Containers - ${RUNNING} running"
          IMAGES=$(docker images | tail -n +2 | wc -l)
          echo "Docker Images - ${IMAGES} total"
          if [ -f '/etc/cron.d/pilito-cleanup' ]; then
            echo "Cleanup Status - Automated"
          else
            echo "Cleanup Status - Manual only"
          fi
          
          echo ""
          echo "Running Services"
          docker ps | grep django_app > /dev/null && echo "  Django App - OK" || echo "  Django App - NOT RUNNING"
          docker ps | grep postgres_db > /dev/null && echo "  PostgreSQL - OK" || echo "  PostgreSQL - NOT RUNNING"
          docker ps | grep redis_cache > /dev/null && echo "  Redis - OK" || echo "  Redis - NOT RUNNING"
          docker ps | grep celery_worker > /dev/null && echo "  Celery Worker - OK" || echo "  Celery Worker - NOT RUNNING"
          docker ps | grep celery_beat > /dev/null && echo "  Celery Beat - OK" || echo "  Celery Beat - NOT RUNNING"
          docker ps | grep prometheus > /dev/null && echo "  Prometheus - OK" || echo "  Prometheus - NOT RUNNING"
          docker ps | grep grafana > /dev/null && echo "  Grafana - OK" || echo "  Grafana - NOT RUNNING"
          
        EOF
