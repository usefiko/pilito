name: Deploy to VPS (Optimized)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

    - name: Add VPS to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: Copy files to VPS
      run: |
        rsync -avz --exclude '.git' --exclude '__pycache__' --exclude '.github' --exclude 'staticfiles' --exclude 'venv' --exclude '*.pyc' --exclude '.env' ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/root/pilito

    - name: SSH and deploy on VPS
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /root/pilito
          
          echo "üöÄ Starting optimized deployment..."
          
          # ‚úÖ Smart Docker cleanup (keep cache for speed)
          echo "üßπ Smart cleanup..."
          docker container prune -f || true
          docker image prune -f || true
          
          # Check disk space
          AVAILABLE_GB=$(df / | awk 'NR==2 {print int($4/1024/1024)}')
          echo "üíæ Available space: ${AVAILABLE_GB}GB"
          
          if [ "$AVAILABLE_GB" -lt 5 ]; then
            echo "‚ö†Ô∏è Low disk space - performing deep cleanup..."
            docker builder prune --filter "until=24h" -f || true
            docker system prune -f || true
          fi
          
          # Stop existing containers
          echo "üõë Stopping containers..."
          docker-compose down || true
          
          # ‚úÖ Build with cache (fast!)
          echo "üî® Building with cache..."
          export DOCKER_BUILDKIT=1
          export COMPOSE_DOCKER_CLI_BUILD=1
          docker-compose build --parallel
          
          # Start all services
          echo "‚ö° Starting services..."
          docker-compose up -d --remove-orphans
          
          # Wait and health check
          echo "‚è≥ Waiting for services..."
          sleep 15
          
          if ! docker-compose ps | grep -q "Up"; then
            echo "‚ùå Containers failed to start!"
            docker-compose logs --tail=30
            exit 1
          fi
          
          # Django checks
          echo "üîß Checking Django..."
          if ! docker exec django_app python manage.py check; then
            echo "‚ùå Django check failed!"
            docker logs django_app --tail 50
            exit 1
          fi
          
          # Migrations
          echo "üìä Running migrations..."
          docker exec django_app python manage.py migrate --noinput
          
          # Static files
          echo "üì¶ Collecting static files..."
          docker exec django_app python manage.py collectstatic --noinput || true
          
          # Celery check
          echo "‚öôÔ∏è Checking Celery..."
          sleep 5
          docker exec celery_worker celery -A core inspect ping > /dev/null 2>&1 && echo "‚úÖ Celery OK" || echo "‚ö†Ô∏è Celery starting..."
          
          # Setup automated weekly cleanup (once)
          if [ ! -f "/etc/cron.d/pilito-cleanup" ]; then
            echo "‚öôÔ∏è Setting up weekly cleanup..."
            cat > /tmp/pilito-cleanup << 'CRON'
# Pilito Weekly Cleanup
0 2 * * 0 root docker system prune -af --volumes >/tmp/cleanup.log 2>&1
0 3 * * * root find /var/lib/docker/containers/ -name "*-json.log" -exec truncate -s 10M {} \; 2>/dev/null
CRON
            mv /tmp/pilito-cleanup /etc/cron.d/pilito-cleanup
            chmod 644 /etc/cron.d/pilito-cleanup
            systemctl reload cron || service cron reload
            echo "‚úÖ Weekly cleanup configured"
          fi
          
          # Summary
          echo ""
          echo "üéâ Deployment completed!"
          echo "üìä Status:"
          docker-compose ps
          
          FINAL_GB=$(df / | awk 'NR==2 {print int($4/1024/1024)}')
          echo "üíæ Free space: ${FINAL_GB}GB"
          
          docker ps | grep django_app > /dev/null && echo "  ‚úÖ Django" || echo "  ‚ùå Django"
          docker ps | grep celery_worker > /dev/null && echo "  ‚úÖ Celery" || echo "  ‚ùå Celery"
          docker ps | grep postgres_db > /dev/null && echo "  ‚úÖ PostgreSQL" || echo "  ‚ùå PostgreSQL"
          docker ps | grep redis_cache > /dev/null && echo "  ‚úÖ Redis" || echo "  ‚ùå Redis"
          
EOF
