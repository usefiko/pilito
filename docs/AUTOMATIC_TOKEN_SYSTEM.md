# ğŸ¤– Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…

## Ø®Ù„Ø§ØµÙ‡

Ø§ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ Ø·ÙˆØ± **Ú©Ø§Ù…Ù„Ø§Ù‹ Ø®ÙˆØ¯Ú©Ø§Ø±** ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ù‡ÛŒÚ† Ø¯Ø®Ø§Ù„Øª Ø¯Ø³ØªÛŒ Ù†ÛŒØ§Ø² Ù†Ø¯Ø§Ø±Ø¯.

### ğŸ¯ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ:

- âœ… **Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ÛŒÚ©â€ŒØ¨Ø§Ø±**: ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ØŒ Ø¨Ù‚ÛŒÙ‡ Ø®ÙˆØ¯Ú©Ø§Ø±
- âœ… **Ø±ÙØ±Ø´ Ø®ÙˆØ¯Ú©Ø§Ø±**: Ù‡Ø± Ø±ÙˆØ² Ø³Ø§Ø¹Øª 3 ØµØ¨Ø­
- âœ… **Ø±ÙØ±Ø´ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ**: Ù‡Ø± 6 Ø³Ø§Ø¹Øª Ø¨Ø±Ø§ÛŒ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù†Ø²Ø¯ÛŒÚ© Ø§Ù†Ù‚Ø¶Ø§  
- âœ… **Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯**: Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…ØŒ Ø®Ø·Ø§Ù‡Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±Ø·Ø±Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
- âœ… **Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ú©Ø§Ù…Ù„**: Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ùˆ Ù‚Ø§Ø¨Ù„ Ø±Ø¤ÛŒØª

---

## ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÛŒØ¹

### Ú¯Ø§Ù… 1: Ù†ØµØ¨ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
```bash
# Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø®ÙˆØ¯Ú©Ø§Ø± (ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø±)
./run_token_refresh_system.sh
```

**Ù‡Ù…ÛŒÙ†!** ğŸ‰ Ø³ÛŒØ³ØªÙ… Ø­Ø§Ù„Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.

### Ú¯Ø§Ù… 2: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
```bash
# Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§
python src/manage.py convert_instagram_tokens --check-only
```

---

## ğŸ“… Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±

Ø³ÛŒØ³ØªÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯:

### ğŸ•’ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø³Ø§Ø¹Øª 3:00 ØµØ¨Ø­
- Ø¨Ø±Ø±Ø³ÛŒ ØªÙ…Ø§Ù… ØªÙˆÚ©Ù†â€ŒÙ‡Ø§
- Ø±ÙØ±Ø´ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¸Ø±Ù 7 Ø±ÙˆØ² Ù…Ù†Ù‚Ø¶ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
- Ú¯Ø²Ø§Ø±Ø´ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± Ù„Ø§Ú¯

### âš¡ Ù‡Ø± 6 Ø³Ø§Ø¹Øª (Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ)
- Ø¨Ø±Ø±Ø³ÛŒ ÙÙˆØ±ÛŒ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§
- Ø±ÙØ±Ø´ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¸Ø±Ù 1 Ø±ÙˆØ² Ù…Ù†Ù‚Ø¶ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
- Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø´Ø±Ø§ÛŒØ· Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ

### ğŸ”„ Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
- Ø§Ú¯Ø± ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ØŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙØ±Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯
- Ù¾ÛŒØ§Ù… Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
- Ú©Ø§Ø±Ø¨Ø± Ù…ØªÙˆØ¬Ù‡ Ù…Ø´Ú©Ù„ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯

---

## ğŸ“Š Ù†Ø¸Ø§Ø±Øª Ùˆ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯

### Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…:
```bash
# Ù„Ø§Ú¯ Worker (Ø¹Ù…Ù„ÛŒØ§Øª Ø±ÙØ±Ø´)
tail -f logs/celery_worker.log

# Ù„Ø§Ú¯ Beat (Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ)
tail -f logs/celery_beat.log

# Ù„Ø§Ú¯ Redis
tail -f logs/redis.log
```

### Django Admin Panel:
```
http://localhost:8000/admin/django_celery_beat/
```
- Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª Periodic Tasks
- ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¬Ø±Ø§Ù‡Ø§

### Ù†Ø¸Ø§Ø±Øª Realtime:
```bash
# Ù…Ø§Ù†ÛŒØªÙˆØ± Celery (Ù†ØµØ¨ Flower Ù„Ø§Ø²Ù…)
pip install flower
celery -A core flower

# Ø¯Ø³ØªØ±Ø³ÛŒ: http://localhost:5555
```

---

## ğŸ› ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒØ³ØªÙ…

### Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ…:
```bash
./run_token_refresh_system.sh
```

### ØªÙˆÙ‚Ù Ø³ÛŒØ³ØªÙ…:
```bash
./stop_token_system.sh
```

### Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª:
```bash
./stop_token_system.sh
./run_token_refresh_system.sh
```

### ØªØ³Øª Ø¯Ø³ØªÛŒ:
```bash
# ØªØ³Øª ÙÙˆØ±ÛŒ (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ)
cd src
python manage.py shell -c "
from message.tasks import auto_refresh_instagram_tokens
result = auto_refresh_instagram_tokens.delay()
print(f'Task ID: {result.id}')
"
```

---

## ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡

### ØªØºÛŒÛŒØ± Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ:

ÙØ§ÛŒÙ„: `src/core/settings/common.py`

```python
CELERY_BEAT_SCHEDULE = {
    'auto-refresh-instagram-tokens': {
        'task': 'message.tasks.auto_refresh_instagram_tokens',
        'schedule': crontab(hour=3, minute=0),  # ØªØºÛŒÛŒØ± Ø³Ø§Ø¹Øª
        'kwargs': {'days_before_expiry': 7},    # ØªØºÛŒÛŒØ± Ø¢Ø³ØªØ§Ù†Ù‡ Ø±ÙˆØ²
    },
}
```

### ØªØºÛŒÛŒØ± Ø¢Ø³ØªØ§Ù†Ù‡ Ø±ÙØ±Ø´:

```python
# Ø±ÙØ±Ø´ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¸Ø±Ù 10 Ø±ÙˆØ² Ù…Ù†Ù‚Ø¶ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
{'days_before_expiry': 10}
```

### ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯â€ŒÙ‡Ø§:

ÙØ§ÛŒÙ„: `src/core/settings/common.py`

```python
LOGGING = {
    'version': 1,
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': 'logs/instagram_tokens.log',
        },
    },
    'loggers': {
        'message.tasks': {
            'handlers': ['file'],
            'level': 'INFO',
        },
    },
}
```

---

## ğŸš¨ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ

### Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ÛŒØ¬:

#### 1. Ø³ÛŒØ³ØªÙ… Ø§Ø¬Ø±Ø§ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
```bash
# Ø¨Ø±Ø±Ø³ÛŒ Redis
redis-cli ping
# Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ø³Ø® "PONG" Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯

# Ø¨Ø±Ø±Ø³ÛŒ virtualenv
which python
# Ø¨Ø§ÛŒØ¯ path ØµØ­ÛŒØ­ Ù†Ø´Ø§Ù† Ø¯Ù‡Ø¯
```

#### 2. ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø±ÙØ±Ø´ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
```bash
# Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§
tail -n 50 logs/celery_worker.log

# ØªØ³Øª Ø¯Ø³ØªÛŒ task
cd src
python manage.py shell -c "
from message.tasks import auto_refresh_instagram_tokens
print(auto_refresh_instagram_tokens.delay().get())
"
```

#### 3. Periodic Tasks Ø§Ø¬Ø±Ø§ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
```bash
# Ø¨Ø±Ø±Ø³ÛŒ Beat
tail -n 20 logs/celery_beat.log

# Ø¨Ø±Ø±Ø³ÛŒ Django Admin
# http://localhost:8000/admin/django_celery_beat/periodictask/
```

#### 4. Redis Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯
```bash
# Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Redis
redis-cli shutdown
redis-server --daemonize yes
```

### Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù…:

**Ù…ÙˆÙÙ‚ÛŒØª Ø±ÙØ±Ø´:**
```
âœ… Successfully refreshed token for channel username
ğŸ“… username: New token expires in 60 days, 0 hours
```

**Ø®Ø·Ø§ÛŒ Ø±ÙØ±Ø´:**
```
âŒ Failed to refresh token for channel username
   All token refresh methods failed
```

**Ø´Ø±ÙˆØ¹ task:**
```
ğŸ”„ Starting automatic Instagram token refresh
ğŸ” Found X connected Instagram channels
```

---

## ğŸ’» Production Deployment

### Systemd Service (Linux):

Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ `/etc/systemd/system/celery.service`:

```ini
[Unit]
Description=Celery Service
After=network.target

[Service]
Type=forking
User=your-app-user
Group=your-app-group
EnvironmentFile=/path/to/your/.env
WorkingDirectory=/path/to/your/project/src
ExecStart=/path/to/your/venv/bin/celery multi start worker1 -A core -Q instagram_tokens --pidfile=/var/run/celery/%n.pid --logfile=/var/log/celery/%n%I.log --loglevel=INFO
ExecStop=/path/to/your/venv/bin/celery multi stopwait worker1 --pidfile=/var/run/celery/%n.pid
ExecReload=/path/to/your/venv/bin/celery multi restart worker1 -A core -Q instagram_tokens --pidfile=/var/run/celery/%n.pid --logfile=/var/log/celery/%n%I.log --loglevel=INFO

[Install]
WantedBy=multi-user.target
```

Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ `/etc/systemd/system/celerybeat.service`:

```ini
[Unit]
Description=Celery Beat Service
After=network.target

[Service]
Type=simple
User=your-app-user
Group=your-app-group
EnvironmentFile=/path/to/your/.env
WorkingDirectory=/path/to/your/project/src
ExecStart=/path/to/your/venv/bin/celery -A core beat --loglevel=INFO
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ:
```bash
sudo systemctl enable celery celerybeat
sudo systemctl start celery celerybeat
```

### Docker Compose:

```yaml
version: '3'
services:
  redis:
    image: redis:alpine
    
  celery_worker:
    build: .
    command: celery -A core worker -Q instagram_tokens --loglevel=info
    depends_on:
      - redis
    environment:
      - REDIS_URL=redis://redis:6379/0
      
  celery_beat:
    build: .
    command: celery -A core beat --loglevel=info
    depends_on:
      - redis
    environment:
      - REDIS_URL=redis://redis:6379/0
```

---

## ğŸ“ˆ Ø¢Ù…Ø§Ø± Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ

### Ø¯Ø³ØªÙˆØ±Ø§Øª Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ:

```bash
# ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
python src/manage.py shell -c "
from settings.models import InstagramChannel
print(f'Active channels: {InstagramChannel.objects.filter(is_connect=True).count()}')
"

# Ø¢Ø®Ø±ÛŒÙ† Ø±ÙØ±Ø´â€ŒÙ‡Ø§
python src/manage.py shell -c "
from django_celery_beat.models import PeriodicTask
from datetime import datetime
tasks = PeriodicTask.objects.filter(enabled=True)
for task in tasks:
    print(f'{task.name}: Last run = {task.last_run_at}')
"

# ÙˆØ¶Ø¹ÛŒØª Ø§Ù†Ù‚Ø¶Ø§ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§
python src/manage.py convert_instagram_tokens --check-only
```

### Monitoring Tools:

1. **Flower** (Web UI Ø¨Ø±Ø§ÛŒ Celery)
2. **Prometheus + Grafana** (Metrics)
3. **Sentry** (Error tracking)
4. **Django Admin** (Task management)

---

## âœ… Ø®Ù„Ø§ØµÙ‡

Ù¾Ø³ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ `./run_token_refresh_system.sh` ÛŒÚ© Ø¨Ø§Ø±:

âœ… **ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙØ±Ø´ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯**  
âœ… **Ù‡ÛŒÚ† Ø¯Ø®Ø§Ù„Øª Ø¯Ø³ØªÛŒ Ù„Ø§Ø²Ù… Ù†ÛŒØ³Øª**  
âœ… **Ø®Ø·Ø§Ù‡Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±Ø·Ø±Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯**  
âœ… **Ø³ÛŒØ³ØªÙ… 24/7 Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯**  

### ğŸ¯ Ù†ØªÛŒØ¬Ù‡:
**Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯ÛŒÚ¯Ø± Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ reconnect Ù†Ø¯Ø§Ø±Ù†Ø¯ Ùˆ Ø³ÛŒØ³ØªÙ… Ø¨Ø¯ÙˆÙ† ÙˆÙ‚ÙÙ‡ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯! ğŸš€**