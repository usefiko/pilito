<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth Test - Fiko</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #3367d6;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            color: #28a745;
            background: #d4edda;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }
        .indicator.success {
            background: #28a745;
        }
        .indicator.error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Google OAuth Test Page</h1>
        <p>This page tests the Google OAuth integration and shows how to handle the callback.</p>
        
        <div class="info">
            <strong>üìã Instructions:</strong>
            <ol>
                <li>Click "Login with Google" to test OAuth flow</li>
                <li>Complete Google authorization</li>
                <li>You'll be redirected back with tokens</li>
                <li>Check the results below</li>
            </ol>
        </div>

        <div class="status">
            <div class="indicator" id="oauth-indicator"></div>
            <span id="oauth-status">Ready to test OAuth</span>
        </div>

        <button class="button" onclick="startGoogleOAuth()">üîê Login with Google</button>
        <button class="button" onclick="testAuthentication()">üîç Test Authentication</button>
        <button class="button" onclick="clearTokens()">üóëÔ∏è Clear Tokens</button>
        <button class="button" onclick="showDebugInfo()">üêõ Debug Info</button>

        <div id="results"></div>
        <div id="debug-info"></div>
    </div>

    <script>
        // Check if this is an OAuth callback
        window.addEventListener('load', function() {
            checkOAuthCallback();
        });

        async function startGoogleOAuth() {
            try {
                updateStatus('Getting Google auth URL...', 'loading');
                
                const response = await fetch('https://api.pilito.com/api/v1/usr/google/auth-url');
                const data = await response.json();
                
                if (data.auth_url) {
                    updateStatus('Redirecting to Google...', 'loading');
                    window.location.href = data.auth_url;
                } else {
                    throw new Error('No auth URL returned');
                }
            } catch (error) {
                updateStatus('Failed to get auth URL: ' + error.message, 'error');
                showResult('error', 'OAuth Start Failed', error.message);
            }
        }

        function checkOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('success') === 'true') {
                handleOAuthSuccess(urlParams);
            } else if (urlParams.get('error')) {
                handleOAuthError(urlParams);
            }
        }

        function handleOAuthSuccess(urlParams) {
            try {
                updateStatus('Processing OAuth success...', 'loading');
                
                // Decode the OAuth data
                const encodedData = urlParams.get('data');
                const authData = JSON.parse(atob(encodedData));
                
                // Store tokens
                localStorage.setItem('access_token', authData.access_token);
                localStorage.setItem('refresh_token', authData.refresh_token);
                localStorage.setItem('user', JSON.stringify({
                    user_id: authData.user_id,
                    email: authData.email,
                    first_name: authData.first_name,
                    last_name: authData.last_name,
                    wizard_complete: authData.wizard_complete
                }));
                
                updateStatus('‚úÖ OAuth successful! Tokens stored.', 'success');
                
                showResult('success', 'OAuth Success!', `
                    <strong>User:</strong> ${authData.email}<br>
                    <strong>Name:</strong> ${authData.first_name} ${authData.last_name}<br>
                    <strong>User ID:</strong> ${authData.user_id}<br>
                    <strong>Wizard Complete:</strong> ${authData.wizard_complete}<br>
                    <strong>Tokens:</strong> Stored in localStorage
                `);

                // Test authentication automatically
                setTimeout(testAuthentication, 1000);
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                updateStatus('Failed to process OAuth data: ' + error.message, 'error');
                showResult('error', 'OAuth Processing Failed', error.message);
            }
        }

        function handleOAuthError(urlParams) {
            const error = urlParams.get('error') || 'Unknown error';
            updateStatus('OAuth failed: ' + error, 'error');
            showResult('error', 'OAuth Failed', error);
        }

        async function testAuthentication() {
            try {
                updateStatus('Testing authentication...', 'loading');
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    throw new Error('No access token found');
                }

                // Test with auth status endpoint
                const response = await fetch('https://api.pilito.com/api/v1/usr/auth/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const statusData = await response.json();
                    updateStatus('‚úÖ Authentication working!', 'success');
                    
                    showResult('success', 'Authentication Test Passed', `
                        <strong>Authenticated:</strong> ${statusData.authenticated}<br>
                        <strong>User:</strong> ${statusData.user ? statusData.user.email : 'Not available'}<br>
                        <strong>Cookies Present:</strong> ${JSON.stringify(statusData.cookies_present)}<br>
                        <pre>${JSON.stringify(statusData, null, 2)}</pre>
                    `);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                updateStatus('Authentication test failed: ' + error.message, 'error');
                showResult('error', 'Authentication Test Failed', error.message);
            }
        }

        function clearTokens() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            updateStatus('Tokens cleared', 'success');
            showResult('info', 'Tokens Cleared', 'All authentication data has been removed from localStorage.');
        }

        function showDebugInfo() {
            const debugInfo = {
                current_url: window.location.href,
                url_params: Object.fromEntries(new URLSearchParams(window.location.search)),
                localStorage: {
                    access_token: localStorage.getItem('access_token') ? '‚úÖ Present' : '‚ùå Missing',
                    refresh_token: localStorage.getItem('refresh_token') ? '‚úÖ Present' : '‚ùå Missing',
                    user: localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')) : '‚ùå Missing'
                },
                cookies: document.cookie ? document.cookie : 'No cookies',
                user_agent: navigator.userAgent
            };

            document.getElementById('debug-info').innerHTML = `
                <h3>üêõ Debug Information</h3>
                <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
            `;
        }

        function updateStatus(message, type = 'info') {
            const indicator = document.getElementById('oauth-indicator');
            const status = document.getElementById('oauth-status');
            
            indicator.className = 'indicator ' + type;
            status.textContent = message;
        }

        function showResult(type, title, message) {
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="${type}">
                    <h3>${title}</h3>
                    <div>${message}</div>
                </div>
            `;
        }

        // Utility function to get cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
    </script>
</body>
</html>
