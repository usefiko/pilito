# Safe migration that handles existing tables and fields
# Generated by Django 5.1.5 on 2025-11-25 14:08

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


def safe_create_intercom_ticket_type(apps, schema_editor):
    """
    Safely create IntercomTicketType table if it doesn't exist.
    """
    from django.db import connection
    
    with connection.cursor() as cursor:
        cursor.execute("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_schema = 'public' 
                AND table_name = 'settings_intercomtickettype'
            )
        """)
        table_exists = cursor.fetchone()[0]
        
        if not table_exists:
            cursor.execute("""
                CREATE TABLE settings_intercomtickettype (
                    id BIGSERIAL PRIMARY KEY,
                    name VARCHAR(100) NOT NULL,
                    department VARCHAR(20) UNIQUE NOT NULL,
                    intercom_ticket_type_id VARCHAR(50) NOT NULL,
                    is_active BOOLEAN DEFAULT TRUE,
                    created_at TIMESTAMP WITH TIME ZONE NOT NULL,
                    updated_at TIMESTAMP WITH TIME ZONE NOT NULL
                )
            """)
            print("âœ… Created IntercomTicketType table")
        else:
            print("â­ï¸  IntercomTicketType table already exists, skipping")


def safe_create_ai_behavior_settings(apps, schema_editor):
    """
    Safely create AIBehaviorSettings table if it doesn't exist.
    """
    from django.db import connection
    
    with connection.cursor() as cursor:
        cursor.execute("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_schema = 'public' 
                AND table_name = 'settings_ai_behavior'
            )
        """)
        table_exists = cursor.fetchone()[0]
        
        if not table_exists:
            cursor.execute("""
                CREATE TABLE settings_ai_behavior (
                    id BIGSERIAL PRIMARY KEY,
                    tone VARCHAR(20) DEFAULT 'friendly',
                    emoji_usage VARCHAR(20) DEFAULT 'moderate',
                    response_length VARCHAR(20) DEFAULT 'balanced',
                    use_customer_name BOOLEAN DEFAULT TRUE,
                    use_bio_context BOOLEAN DEFAULT TRUE,
                    persuasive_selling_enabled BOOLEAN DEFAULT FALSE,
                    persuasive_cta_text VARCHAR(300) DEFAULT 'Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø³ÙØ§Ø±Ø´ Ø¯Ù‡ÛŒØ¯ØŸ ğŸ›’',
                    unknown_fallback_text VARCHAR(500) DEFAULT 'Ù…Ù† Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù¾Ø§Ø³Ø® Ø¯Ù‚ÛŒÙ‚ Ø§ÛŒÙ† Ø³ÙˆØ§Ù„ Ø±Ø§ Ù†Ø¯Ø§Ø±Ù…ØŒ Ø§Ù…Ø§ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†Ù… Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ø±Ø§ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø¯Ø§Ø¯.',
                    custom_instructions TEXT,
                    created_at TIMESTAMP WITH TIME ZONE NOT NULL,
                    updated_at TIMESTAMP WITH TIME ZONE NOT NULL,
                    user_id BIGINT UNIQUE NOT NULL REFERENCES accounts_user(id) ON DELETE CASCADE
                )
            """)
            print("âœ… Created AIBehaviorSettings table")
        else:
            print("â­ï¸  AIBehaviorSettings table already exists, skipping")


def safe_add_fields_to_generalsettings(apps, schema_editor):
    """
    Safely add fields to GeneralSettings if they don't exist.
    """
    from django.db import connection
    
    with connection.cursor() as cursor:
        # Get existing columns
        cursor.execute("""
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name='settings_generalsettings' AND table_schema='public'
        """)
        existing_columns = [row[0] for row in cursor.fetchall()]
        
        fields_to_add = [
            ("ai_role", "TEXT DEFAULT 'You are a sales assistant, NOT a support agent.\nYour goal is to understand customer needs and recommend relevant products/services.\nAlways look for opportunities to suggest products that match their needs.\nBe helpful, friendly, and proactive in offering solutions.'"),
            ("anti_hallucination_rules", "TEXT DEFAULT 'ğŸš¨ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¶Ø¯ ØªÙˆÙ‡Ù…â€ŒØ²Ø§ÛŒÛŒ (Critical):\n\n1) Ù‡Ù…ÛŒØ´Ù‡ Ø§ÙˆÙ„ Ú©Ø§Ù†ØªÚ©Ø³Øª Ùˆ Ù†Ø§Ù„Ø¬ Ø±Ø§ Ú†Ú© Ú©Ù†:\n   - Ø§Ú¯Ø± chunk/FAQ/Ù…Ø­ØµÙˆÙ„/Ø³Ø§ÛŒØª Ø¯Ø± Ú©Ø§Ù†ØªÚ©Ø³Øª Ù‡Ø³Øª â†’ Ø§Ø² Ù‡Ù…Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†\n   - Ø§Ú¯Ø± Ú†ÛŒØ²ÛŒ Ø¯Ø± Ú©Ø§Ù†ØªÚ©Ø³Øª Ù†ÛŒØ³ØªØŒ Ø®ÙˆØ¯Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø³Ø§Ø²\n\n2) Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ù‡Ø±Ú¯Ø² Ø§Ø®ØªØ±Ø§Ø¹ Ù†Ú©Ù†:\n   - Ø¢Ø¯Ø±Ø³ØŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ØŒ Ù‚ÛŒÙ…ØªØŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒØŒ Ù„ÛŒÙ†Ú©\n   - Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­ØµÙˆÙ„ ÛŒØ§ Ø®Ø¯Ù…Ø§ØªÛŒ Ú©Ù‡ ØªÙˆ Ú©Ø§Ù†ØªÚ©Ø³Øª Ù†ÛŒØ³Øª\n   - Ù‡ÛŒÚ†â€ŒÙˆÙ‚Øª Ù†Ú¯Ùˆ \"Ø§Ù„Ø§Ù† Ù…ÛŒâ€ŒÙØ±Ø³ØªÙ…\" Ø§Ú¯Ø± Ø§Ù„Ø§Ù† Ù†Ø¯Ø§Ø±ÛŒ\n\n3) Ø§Ú¯Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø¯Ø§Ø±ÛŒ:\n   - ØµØ§Ø¯Ù‚Ø§Ù†Ù‡ Ø¨Ú¯Ùˆ: \"Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù„Ø§Ù† ØªÙˆ Ø¯Ø§Ù†Ø´ Ù…Ù† Ù†ÛŒØ³Øª\"\n   - Ø§Ø² Ù…ØªÙ† knowledge_limitation_response Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†\n\n4) Ù„ÛŒÙ†Ú© Ùˆ ÙˆØ¨â€ŒØ³Ø§ÛŒØª (Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù…):\n   - Ø§Ú¯Ø± ÙÙ‚Ø· ÛŒÚ© Ù„ÛŒÙ†Ú© Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒ Ùˆ Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø¯Ø± Ú©Ø§Ù†ØªÚ©Ø³Øª Ù†ÛŒØ³ØªØŒ Ø§ØµÙ„Ø§Ù‹ Ø­Ø¯Ø³ Ù†Ø²Ù†\n   - Ø¨Ú¯Ùˆ: \"Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù…Ù† Ù†Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ù…Ø­ØªÙˆØ§ÛŒ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ù…. Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ÛŒ Ø±Ø§Ø¬Ø¹ Ø¨Ù‡Ø´ Ø¯Ø§Ø±ÛŒØŒ Ù„Ø·ÙØ§Ù‹ ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯Ù‡.\"\n   \n   âš ï¸ CRITICAL: If user sends ONLY a URL without context:\n   - NEVER guess what the link is about\n   - Say you can''t see the content\n\n5) Ù¾Ø³Øª/Ø±ÛŒÙ„Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…:\n   - ØªÙˆ ÙÙ‚Ø· caption/Ù…ØªÙ† Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒØŒ Ù†Ù‡ ØªØµÙˆÛŒØ±/ÙˆÛŒØ¯ÛŒÙˆ\n   - Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‡Ù…Ø§Ù† Ù…ØªÙ† Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù‡ØŒ Ù†Ù‡ Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ø¯Ø§Ø®Ù„ ØªØµÙˆÛŒØ± Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø´Ø¯'"),
            ("custom_instructions", "TEXT"),
            ("greeting_rules", "TEXT DEFAULT 'â›” CRITICAL RULE: Say ''Ø³Ù„Ø§Ù…'' or ''Hi'' ONLY ONCE per conversation!\n\nWhen you see \"SCENARIO: FIRST_MESSAGE\":\nâ†’ Greet with customer''s name ONCE: \"Ø³Ù„Ø§Ù… [Ù†Ø§Ù…]!\"\nâ†’ Then answer their question naturally\n\nWhen you see \"SCENARIO: WELCOME_BACK\":\nâ†’ Say \"Ø®ÙˆØ´ Ø¨Ø±Ú¯Ø´ØªÛŒ!\" ONCE (do NOT say Ø³Ù„Ø§Ù…)\nâ†’ Then answer directly\n\nWhen you see \"SCENARIO: RECENT_CONVERSATION\":\nâ†’ Do NOT greet at all\nâ†’ Answer the question DIRECTLY without any greeting word\nâ†’ Example: \"Ø¨Ù„Ù‡ØŒ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú© Ú©Ù†Ù…...\"\n\nâ›” NEVER say \"Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø³Ù„Ø§Ù…\" or repeat any greeting!'"),
            ("knowledge_limitation_response", "TEXT DEFAULT 'Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ùˆ Ù†Ø¯Ø§Ø±Ù…. Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø¨Ù‡Øª Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø§ØµÙ„ÛŒâ€ŒÙ…ÙˆÙ† Ú©Ù…Ú© Ú©Ù†Ù…ØŒ ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø¨Ø§ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØµØ­Ø¨Øª Ú©Ù†ÛŒØŸ'"),
            ("language_rules", "TEXT DEFAULT 'Always reply in Persian (Farsi).\nConvert Latin names to Persian equivalents (e.g., Omid â†’ Ø§Ù…ÛŒØ¯).\nUse everyday Persian expressions, not formal sentences.'"),
            ("link_handling_rules", "TEXT DEFAULT 'ğŸ”— LINK RULES:\n1. For IMPORTANT links (website/product): [[CTA:Ø¹Ù†ÙˆØ§Ù†|https://url]]\n   Example: [[CTA:Ø³Ø§ÛŒØª Ù…Ø§|https://pilito.com]]\n2. For casual links: plain URL (https://...)\n3. NEVER use placeholders like [link] or invent URLs'"),
            ("openai_api_key", "VARCHAR(200)"),
            ("response_guidelines", "TEXT DEFAULT 'Maximum 600 characters for Instagram compatibility.\nMaximum 3-4 sentences per response.\nLimit emojis to 1 per message.\nAvoid long introductions â€” go straight to the point.\nIf topic is complex, give a short summary. User can ask for details.\n\nğŸ¯ PERSONALIZATION WITH BIO:\n- If customer has a bio, USE IT in your first response\n- Mention their work/interest naturally to show you understand them\n- Example: \"Ø¯ÛŒØ¯Ù… Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒØ³Øª Ø¨Ø±Ù†Ø¯ÛŒÙ†Ú¯ Ù‡Ø³ØªÛŒØŒ ÙÛŒÚ©Ùˆ Ø¨Ø±Ø§Øª Ø¹Ø§Ù„ÛŒÙ‡!\"\n- Convert Latin names to Persian (Omid â†’ Ø§Ù…ÛŒØ¯)\n\nğŸ“·ğŸ¤ MEDIA MESSAGE RULE:\n- If you see ''[sent an image]:'', the customer SENT an image (not described it)\n- If you see ''[sent a voice message]:'', the customer SENT audio (not typed it)\n- The text after is AI analysis of their media\n- Respond naturally about what they sent, don''t say ''you described'''"),
            ("response_length", "VARCHAR(20) DEFAULT 'concise'"),
            ("tone_and_style", "TEXT DEFAULT 'Speak casually and emotionally, not like a brochure.\nWrite like a person chatting on Instagram.\nKeep responses under 2 short lines.'"),
            ("welcome_back_threshold_hours", "INTEGER DEFAULT 12"),
        ]
        
        for field_name, field_def in fields_to_add:
            if field_name not in existing_columns:
                try:
                    cursor.execute(f"""
                        ALTER TABLE settings_generalsettings 
                        ADD COLUMN {field_name} {field_def}
                    """)
                    print(f"âœ… Added {field_name} column")
                except Exception as e:
                    print(f"âš ï¸  Could not add {field_name}: {e}")
            else:
                print(f"â­ï¸  {field_name} column already exists, skipping")


def safe_add_fields_to_supportticket(apps, schema_editor):
    """
    Safely add fields to SupportTicket if they don't exist.
    """
    from django.db import connection
    
    with connection.cursor() as cursor:
        # Get existing columns
        cursor.execute("""
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name='settings_supportticket' AND table_schema='public'
        """)
        existing_columns = [row[0] for row in cursor.fetchall()]
        
        if 'intercom_ticket_id' not in existing_columns:
            try:
                cursor.execute("""
                    ALTER TABLE settings_supportticket 
                    ADD COLUMN intercom_ticket_id VARCHAR(255) UNIQUE
                """)
                print("âœ… Added intercom_ticket_id column")
            except Exception as e:
                print(f"âš ï¸  Could not add intercom_ticket_id: {e}")
        else:
            print("â­ï¸  intercom_ticket_id column already exists, skipping")


def reverse_migration(apps, schema_editor):
    """
    Reverse migration - be careful with this in production!
    """
    pass  # We won't remove tables/columns in reverse to avoid data loss


class Migration(migrations.Migration):

    dependencies = [
        ('settings', '0015_merge_20251125_1403'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        # Create IntercomTicketType table safely
        migrations.RunPython(safe_create_intercom_ticket_type, reverse_migration),
        
        # Create AIBehaviorSettings table safely
        migrations.RunPython(safe_create_ai_behavior_settings, reverse_migration),
        
        # Add fields to GeneralSettings safely
        migrations.RunPython(safe_add_fields_to_generalsettings, reverse_migration),
        
        # Add fields to SupportTicket safely
        migrations.RunPython(safe_add_fields_to_supportticket, reverse_migration),
    ]
